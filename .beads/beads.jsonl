{"id":"mcp_agent_mail-8m0","content_hash":"db92fdc9d9f7640c7b8d98b196010326c4470887d4bafb0bd75bfd1e4868b00f","title":"Add tests for agent deregistration","description":"## Overview\nComprehensive test coverage for the deregistration feature.\n\n## Unit Tests\n- test_deregister_basic: verify all cleanup operations\n- test_deregister_idempotent: deregister twice works\n- test_deregister_nonexistent: unknown agent succeeds\n- test_deregister_delete_inbox: verify inbox deletion option\n- test_reactivation: register/deregister/register cycle\n\n## Integration Tests\n- test_send_to_deregistered: clear error message\n- test_send_from_deregistered: clear error message\n- test_whois_deregistered: works, shows deregistered_ts\n- test_list_contacts_excludes_deregistered\n- test_agents_resource_excludes_deregistered\n\n## Acceptance Criteria\n- [ ] All unit tests pass\n- [ ] All integration tests pass\n- [ ] Edge case coverage","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:49.619359-08:00","updated_at":"2025-11-24T14:02:16.469912-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-8m0","depends_on_id":"mcp_agent_mail-e69","type":"blocks","created_at":"2025-11-24T14:03:18.570007-08:00","created_by":"daemon"},{"issue_id":"mcp_agent_mail-8m0","depends_on_id":"mcp_agent_mail-crk","type":"blocks","created_at":"2025-11-24T14:03:18.643555-08:00","created_by":"daemon"},{"issue_id":"mcp_agent_mail-8m0","depends_on_id":"mcp_agent_mail-dhm","type":"blocks","created_at":"2025-11-24T14:03:18.72604-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-crk","content_hash":"3f577d5188928059c42c4750436904ee7aca5c8134f01cd6046261f86ed274ac","title":"Support agent reactivation on re-registration","description":"## Overview\nWhen registering an agent name that was previously deregistered, clear the deregistered_ts to reactivate.\n\n## Implementation\nModify _get_or_create_agent() in app.py to clear deregistered_ts if set when updating existing agent.\n\n## Behavior Notes\n- Reactivation does NOT restore old contact links (must re-establish)\n- Reactivation does NOT restore inbox if delete_inbox=True was used\n- Agent gets fresh metadata (program, model, task_description)\n\n## Acceptance Criteria\n- [ ] Registering a deregistered name clears deregistered_ts\n- [ ] Agent profile updated in archive without deregistered_ts field\n- [ ] Old contact links remain deleted","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:48.253995-08:00","updated_at":"2025-11-24T14:02:13.212175-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-crk","depends_on_id":"mcp_agent_mail-vq4","type":"blocks","created_at":"2025-11-24T14:03:18.42146-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-dhm","content_hash":"cc18ca9a8d1b7f41c31481a2b79304e6ca1126f3d904787dc06c2ffe9e5d5cd4","title":"Filter deregistered agents from queries","description":"## Overview\nAdd deregistered_ts IS NULL filtering to queries so deregistered agents are invisible.\n\n## Changes Required\n1. Add _get_agent_including_deregistered() helper for whois\n2. Update _get_agent() to filter deregistered_ts IS NULL\n3. Update send_message to reject deregistered sender/recipients\n4. Update list_contacts to exclude deregistered\n5. Update request_contact to reject deregistered\n6. Update resource://agents to exclude deregistered\n\n## NOT Filtered\n- whois - should work for audit/history lookup\n\n## Acceptance Criteria\n- [ ] _get_agent() excludes deregistered\n- [ ] send_message rejects deregistered sender/recipients\n- [ ] list_contacts excludes deregistered\n- [ ] request_contact rejects deregistered\n- [ ] resource://agents excludes deregistered\n- [ ] whois still works on deregistered agents","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:48.944027-08:00","updated_at":"2025-11-24T14:02:14.80363-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-dhm","depends_on_id":"mcp_agent_mail-vq4","type":"blocks","created_at":"2025-11-24T14:03:18.492639-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-e69","content_hash":"90849df0c8be9169b3564c365b06b93af2d9ad387935e83b5c77ae0a824aaec3","title":"Implement deregister_agent tool","description":"## Overview\nNew MCP tool to soft-delete an agent identity from a project.\n\n## Tool Signature\n```python\n@mcp.tool(name=\"deregister_agent\")\nasync def deregister_agent(\n    ctx: Context,\n    project_key: str,\n    agent_name: str,\n    delete_inbox: bool = False,\n) -\u003e dict[str, Any]\n```\n\n## Cleanup Operations (in order)\n1. Validate agent exists\n2. Set deregistered_ts = NOW() on agent record\n3. DELETE from agent_links where agent is a_agent_id OR b_agent_id\n4. UPDATE file_reservations SET released_ts=NOW() where agent_id=? AND released_ts IS NULL\n5. Release build slots (file-based) - delete/expire JSON files matching agent\n6. If delete_inbox: DELETE from message_recipients where agent_id=?\n7. Write updated profile to archive with deregistered_ts\n\n## Return Value\n- agent_name, was_registered, already_deregistered\n- contact_links_removed, file_reservations_released\n- build_slots_released, inbox_records_deleted\n\n## Idempotency\n- Non-existent agent: was_registered=False, no error\n- Already deregistered: already_deregistered=True, no error","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-24T14:01:47.664311-08:00","updated_at":"2025-11-24T14:02:11.749871-08:00","source_repo":".","dependencies":[{"issue_id":"mcp_agent_mail-e69","depends_on_id":"mcp_agent_mail-vq4","type":"blocks","created_at":"2025-11-24T14:03:18.35315-08:00","created_by":"daemon"}]}
{"id":"mcp_agent_mail-vq4","content_hash":"3b514f9bc9029b7542cf4bc5a8f2dbb297958e288eaa3ff8c551bfe4b914a123","title":"Add deregistered_ts field to Agent model","description":"## Overview\nAdd soft-delete support for agents via a new timestamp field.\n\n## Implementation\n- Add `deregistered_ts: Optional[datetime] = Field(default=None)` to Agent model in models.py\n- Field is nullable - None means agent is active\n- No index needed (rare query pattern)\n\n## Acceptance Criteria\n- [ ] Field added to Agent model\n- [ ] Database migration works (new installs + existing DBs)\n- [ ] Field appears in agent profile JSON serialization","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-24T14:01:47.048524-08:00","updated_at":"2025-11-24T14:02:10.120964-08:00","source_repo":"."}
